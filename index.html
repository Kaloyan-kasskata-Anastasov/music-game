<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Music Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }

  #player {
    margin-top: 20px;
    display: none;
  }

  button {
    margin-top: 20px;
    padding: 14px 24px;
    font-size: 18px;
  }
</style>
</head>
<body>

<div id="player"></div>
<button id="playBtn">â–¶ Play preview</button>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
const START_TIME = 90;
const PREVIEW_LENGTH = 30;
const BUFFER_START = 40;      
const BUFFER_END = 50;   

const params = new URLSearchParams(window.location.search);
const requestVideoId = params.get('videoId');
if (!requestVideoId) {
    document.body.innerHTML = '<p style="color:red">Invalid QR code (missing requestVideoId)</p>';
    throw new Error('Missing requestVideoId');
  }

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '180',
    width: '320',
    videoId: requestVideoId,
    playerVars: {
      // start: START_TIME,
      // end: START_TIME + PREVIEW_LENGTH,
      // controls: 0,
      modestbranding: 1,
      rel: 0
    },
    events: {
      onReady: onPlayerReady
    }
  });
}

function onPlayerReady() {
  if (!player)
  {
      throw new Error('Player not loaded');
  }
  console.log("Player ready");
  const duration = 200;

  if (duration < BUFFER_START + BUFFER_END + PREVIEW_LENGTH) {
    console.warn('Song too short, starting at 0');
    playPreview(0);
    return;
  }

  const minStart = BUFFER_START;
  const maxStart = duration - BUFFER_END - PREVIEW_LENGTH;

  const randomStart =
    Math.floor(Math.random() * (maxStart - minStart + 1)) + minStart;

  playPreview(randomStart);
}

function playPreview(startTime) {
  player.seekTo(startTime, true);
  player.playVideo();

  setTimeout(() => {
    player.stopVideo();
  }, PREVIEW_LENGTH);
}

document.getElementById('playBtn').addEventListener('click', () => {
  onPlayerReady();
  
  // setTimeout(() => {
  // document.getElementById('player').style.display = 'block';
  // player.playVideo();
  // console.log("PLAY");
  // },1000);

// setTimeout(() => {
//   player.playVideo();
//   console.log("PLAY");
//   },1000);

//   setTimeout(() => {
//     player.stopVideo();
//     console.log("STOP");
//   }, PREVIEW_LENGTH);
});
</script>

</body>
</html>
